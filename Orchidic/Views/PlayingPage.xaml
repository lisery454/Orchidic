<UserControl x:Class="Orchidic.Views.PlayingPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:Orchidic.Views"
             xmlns:utils="clr-namespace:Orchidic.Utils"
             xmlns:viewModels="clr-namespace:Orchidic.ViewModels"
             xmlns:components="clr-namespace:Orchidic.Views.Components"
             xmlns:b="http://schemas.microsoft.com/xaml/behaviors"
             d:DataContext="{d:DesignInstance Type=viewModels:PlayingPageViewModel}"
             mc:Ignorable="d"
             ClipToBounds="False"
             d:DesignHeight="300" d:DesignWidth="300">

  <UserControl.Resources>
    <local:CoverSizeConverter x:Key="CoverSizeConverter" />
    <local:PanelHeightConverter x:Key="PanelHeightConverter" />
    <local:TimeSpanToStringConverter x:Key="TimeSpanToStringConverter" />
    <local:VolumeToStringConverter x:Key="VolumeToStringConverter" />

  </UserControl.Resources>

  <Grid>
    <Grid x:Name="Page" MaxWidth="1000" HorizontalAlignment="Stretch">
      <Grid.RowDefinitions>
        <RowDefinition Height="*" />
        <RowDefinition Height="Auto" />
      </Grid.RowDefinitions>

      <!-- cover -->
      <Grid Grid.Row="0" x:Name="CoverParent" ClipToBounds="True">
        <Button HorizontalAlignment="Center" VerticalAlignment="Center"
                Command="{Binding PlayOrPauseCommand}"
                Style="{StaticResource CoverAnimatedButton}">
          <Grid Background="Transparent" IsHitTestVisible="True">
            <utils:SuperellipseBorder Fill="Transparent" ClipToBounds="true" IsHitTestVisible="True"
                                      Power="5" HorizontalAlignment="Center" VerticalAlignment="Center"
                                      CornerRadius="70">
              <utils:SuperellipseBorder.Width>
                <MultiBinding Converter="{StaticResource CoverSizeConverter}">
                  <Binding Path="ActualWidth" ElementName="CoverParent" />
                  <Binding Path="ActualHeight" ElementName="CoverParent" />
                </MultiBinding>
              </utils:SuperellipseBorder.Width>

              <utils:SuperellipseBorder.Height>
                <MultiBinding Converter="{StaticResource CoverSizeConverter}">
                  <Binding Path="ActualWidth" ElementName="CoverParent" />
                  <Binding Path="ActualHeight" ElementName="CoverParent" />
                </MultiBinding>
              </utils:SuperellipseBorder.Height>

              <Grid>
                <Grid>
                  <Image
                    Stretch="UniformToFill"
                    SnapsToDevicePixels="True"
                    UseLayoutRounding="True"
                    RenderOptions.BitmapScalingMode="HighQuality"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center">
                    <b:Interaction.Behaviors>
                      <utils:ImageFadeBehavior Source="{Binding AudioQueueService.CurrentCover}" />
                    </b:Interaction.Behaviors>
                    <Image.Width>
                      <MultiBinding Converter="{StaticResource CoverSizeConverter}">
                        <Binding Path="ActualWidth" ElementName="CoverParent" />
                        <Binding Path="ActualHeight" ElementName="CoverParent" />
                      </MultiBinding>
                    </Image.Width>
                    <Image.Height>
                      <MultiBinding Converter="{StaticResource CoverSizeConverter}">
                        <Binding Path="ActualWidth" ElementName="CoverParent" />
                        <Binding Path="ActualHeight" ElementName="CoverParent" />
                      </MultiBinding>
                    </Image.Height>
                  </Image>
                </Grid>
                <!-- 半透明黑色遮罩，调整 alpha 控制暗度 -->
                <Rectangle IsHitTestVisible="False" Fill="{DynamicResource CoverMaskBrush}" />
              </Grid>


            </utils:SuperellipseBorder>
          </Grid>
          <Button.Effect>
            <DropShadowEffect Color="{DynamicResource CoverShadowColor}"
                              RenderingBias="Performance"
                              BlurRadius="40"
                              ShadowDepth="0"
                              Opacity="0.7" />
          </Button.Effect>
        </Button>
      </Grid>


      <!-- below -->
      <Grid Grid.Row="1"
            Height="{Binding  ActualHeight, ElementName=Page, Converter={StaticResource PanelHeightConverter}}"
            Background="Transparent">
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- title -->
        <Grid Grid.Row="0">
          <TextBlock FontSize="22" Margin="0,10,0,10" HorizontalAlignment="Center" VerticalAlignment="Center"
                     Text="{Binding AudioQueueService.AudioQueue.CurrentAudioFile.Name}"
                     Foreground="{DynamicResource FontBrush}" />
        </Grid>

        <!-- progress bar -->
        <Grid Grid.Row="1" Height="50">
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
          </Grid.ColumnDefinitions>
          <Grid Grid.Column="0" Width="160">
            <TextBlock Text="{Binding PlayerService.CurrentTime, Converter={StaticResource TimeSpanToStringConverter}}"
                       Foreground="{DynamicResource FontBrush}" FontSize="18"
                       FontWeight="Bold"
                       FontFamily="{StaticResource MonoFont}"
                       Margin="0,0,30,0" HorizontalAlignment="Right"
                       VerticalAlignment="Center">
            </TextBlock>
          </Grid>
          <Grid Grid.Column="1">
            <components:SelfSlider Progress="{Binding PlayerService.Progress, Mode=TwoWay}">
            </components:SelfSlider>
          </Grid>
          <Grid Grid.Column="2" Width="160">
            <TextBlock Text="{Binding PlayerService.TotalTime, Converter={StaticResource TimeSpanToStringConverter}}"
                       Foreground="{DynamicResource FontBrush}" FontSize="18"
                       FontFamily="{StaticResource MonoFont}"
                       FontWeight="Bold"
                       Margin="30,0,0,0" HorizontalAlignment="Left"
                       VerticalAlignment="Center">
            </TextBlock>
          </Grid>
        </Grid>

        <!-- button -->
        <Grid Grid.Row="2" HorizontalAlignment="Center" Margin="0,20,0,0">
          <StackPanel Orientation="Horizontal">
            <Grid Margin="0,0,34,0" Width="100" />
            <components:SvgIconButton
              Width="20"
              Height="20"
              Margin="18,0,18,0"
              IconData="{StaticResource EyeIconGeometry}"
              Command="{Binding SetZenModeCommand}">
              <components:SvgIconButton.IconBrush>
                <MultiBinding Converter="{StaticResource ConditionConverter}">
                  <Binding Path="GlobalService.IsZenMode" />
                  <Binding Source="{StaticResource PrimaryBrush}" />
                  <Binding Source="{StaticResource SecondaryBrush}" />
                </MultiBinding>
              </components:SvgIconButton.IconBrush>
              <components:SvgIconButton.HoverBrush>
                <MultiBinding Converter="{StaticResource ConditionConverter}">
                  <Binding Path="GlobalService.IsZenMode" />
                  <Binding Source="{StaticResource LightPrimaryBrush}" />
                  <Binding Source="{StaticResource LightSecondaryBrush}" />
                </MultiBinding>
              </components:SvgIconButton.HoverBrush>
              <components:SvgIconButton.PressedBrush>
                <MultiBinding Converter="{StaticResource ConditionConverter}">
                  <Binding Path="GlobalService.IsZenMode" />
                  <Binding Source="{StaticResource DarkPrimaryBrush}" />
                  <Binding Source="{StaticResource DarkSecondaryBrush}" />
                </MultiBinding>
              </components:SvgIconButton.PressedBrush>
            </components:SvgIconButton>
            <components:SvgIconButton
              Width="36"
              Height="36"
              Margin="18,0,18,0"
              IconData="{StaticResource PrevIconGeometry}"
              IconBrush="{StaticResource SecondaryBrush}"
              HoverBrush="{StaticResource LightSecondaryBrush}"
              PressedBrush="{StaticResource DarkSecondaryBrush}"
              Command="{Binding PrevAudioCommand}" />
            <components:SvgIconButton
              Width="34"
              Height="34"
              Margin="18,0,18,0"
              IconBrush="{StaticResource SecondaryBrush}"
              HoverBrush="{StaticResource LightSecondaryBrush}"
              PressedBrush="{StaticResource DarkSecondaryBrush}"
              Command="{Binding PlayOrPauseCommand}">
              <components:SvgIconButton.IconData>
                <MultiBinding Converter="{StaticResource ConditionConverter}">
                  <Binding Path="PlayerService.IsPlaying" />
                  <Binding Source="{StaticResource PauseIconGeometry}" />
                  <Binding Source="{StaticResource PlayIconGeometry}" />
                </MultiBinding>
              </components:SvgIconButton.IconData>
            </components:SvgIconButton>
            <components:SvgIconButton
              Width="36"
              Height="36"
              Margin="18,0,18,0"
              IconData="{StaticResource NextIconGeometry}"
              IconBrush="{StaticResource SecondaryBrush}"
              HoverBrush="{StaticResource LightSecondaryBrush}"
              PressedBrush="{StaticResource DarkSecondaryBrush}"
              Command="{Binding NextAudioCommand}" />
            <Grid Width="100" Margin="10,0,10,0">
              <components:SelfSlider Progress="{Binding PlayerService.Volume}"></components:SelfSlider>
            </Grid>
            <TextBlock Text="{Binding PlayerService.Volume, Converter={StaticResource VolumeToStringConverter}}"
                       Foreground="{DynamicResource FontBrush}" FontSize="18"
                       FontFamily="{StaticResource MonoFont}"
                       FontWeight="Bold"
                       Width="50"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center">
            </TextBlock>
          </StackPanel>
        </Grid>

      </Grid>
    </Grid>
  </Grid>

</UserControl>